---
title: "Reinterventions exploration"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(
  echo = TRUE, 
  root.dir=normalizePath('../../')
)
```

```{r warning=FALSE, include=FALSE}
library(readxl)
library(magrittr)
library(data.table)
library(stringr)
library(yaml)
library(GGally)

source('code/basic.R')
source('code/utils.R')

xls_path <- 'data/ESSG extraction July 2020_2.xlsx'
# excel_sheets(xls_path)

vars_ <- read_yaml('code/reintervention/treatment_vars.yml')

rev_patients <- read_excel(xls_path, sheet = "Rev surgeries") %>% 
  data.table %>% 
  .[, `Code of the patient`] %>% 
  unique

read_excel(xls_path) %>% 
  as.data.table() %>% 
  .[, .SD, .SDcols=c('Code of the patient', vars_ %>% unlist)] %>% 
  .[, `Rev Surgery` := ifelse(`Code of the patient` %chin% rev_patients, 'Yes', 'No')] %>% 
  .[, `Code of the patient` := NULL] %>% 
  clean_names_dt %>% 
  .[, co3 := 0] %>% 
  .[schwab_type_3_number + schwab_type_4_number + schwab_type_5_number > 0, co3 := 1] %>% 
  .[, schwab_type_3_number := NULL] %>% 
  .[, schwab_type_4_number := NULL] %>% 
  .[, schwab_type_5_number := NULL] %>% 
  .[, pelvic_fixation := 0] %>% 
  .[grepl('Iliac', posterior_instrumented_fusion_upper_lower_levels, fixed=TRUE), 
    pelvic_fixation := 1] %>% 
  .[, posterior_instrumented_fusion_upper_lower_levels:=NULL] ->
  data_

vars_$outcomes %<>% c('rev_surgery')

```

```{r echo=FALSE, comment=""}
cat(vars_ %>% as.yaml)
```

## Treatment Combinations
```{r echo=FALSE, fig.width=12, fig.height=8}
factor_cols <- colnames(data_)[ data_ %>% sapply(is.character) ]

data_ %>% 
  .[, .SD, .SDcols=factor_cols] %>% 
  .[, surgical_approach := surgical_approach %>% 
    gsub('Posterior', 'p', ., fixed=TRUE) %>% 
    gsub('Anterior', 'a', ., fixed=TRUE)
  ] ->
  facts
facts[is.na(facts)] <- 'NA'

facts %>% 
  colnames %>% 
  sapply(. %>% gsub('_', '\n', ., fixed=TRUE)) ->
  new_names
colnames(facts) <- new_names

ggpairs(facts, 
  upper = list(discrete='blank'),
  diag=list(discrete='blankDiag'),
  lower = list(discrete='ratio')
) +
  theme(
    axis.text.x = element_text(angle = 30, vjust = 0.5, hjust=1),
    strip.text.x=element_text(angle=30, hjust=0.5, vjust=0.5, size=10),
    axis.text.y = element_text(angle=30, vjust = 0.5, hjust=1),
    strip.text.y=element_text(angle=30, hjust=0.5, vjust=0.5, size=10)
  ) 
```

## Response Variables

```{r echo=FALSE, warning=FALSE, include=FALSE}
cont_vars_ <- list(
  `number_of_posterior_instrumented_levels`="number_of_posterior\ninstrumented_levels",
  co3="co3",
  `total_surgical_time_st1_st2_st3`="total_surgical_time\nst1_st2_st3",
  `total_blood_loss_ml_st1_st2_st3`="total_blood_loss\nst1_st2_st3",
  `1y._odi_score_`="1y._odi_score_",
  `1y._srs22_srs_subtotal_score`="1y._srs22_srs\nsubtotal_score",
  `1y._sf36_mcs`="1y._sf36_mcs",
  `1y._sf36_pcs`="1y._sf36_pcs",
  rev_surgery="rev_surgery"
)

data_ %>% 
  .[, .SD, .SDcols=cont_vars_ %>% names] %>% 
  .[, co3 := as.factor(co3)]->
  cont_data

for(var_name_ in cont_vars_ %>% names){
  setnames(cont_data, var_name_, cont_vars_[[var_name_]])
}

cont_data %>%
  ggpairs(
    upper = list(continuous = "cor", combo = "facethist", discrete = "facetbar", na =
    "na"),
  lower = list(continuous = "points", combo = "box_no_facet", discrete = "facetbar", na =
    "na")
  ) +
  theme(
    axis.text.x = element_text(angle = 30, vjust = 0.5, hjust=1),
    strip.text.y=element_text(angle=30, hjust=0.5, vjust=0.5, size=10)
  ) -> 
  response_plot
```

```{r echo=FALSE, warning=FALSE, fig.width=12, fig.height=8}
response_plot
```

