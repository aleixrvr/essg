---
title: "Loss of alignment"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include=FALSE, message=FALSE, warning=FALSE, comment="")
```

```{r}
library(data.table)
library(magrittr)
library(yaml)
library(DiagrammeR)
library(lme4)
library(lmerTest)

source('patient_selection.R')
factors_loss <- read_yaml('factors_loss.yml')
```

```{r}
data_ <- get_data()
```


```{r}
data_ %<>% .[`Posterior Instrumented Fusion` == 'Yes']
```
With Posterior Instrumented Fusion: `r data_[, .N]`

```{r}
data_[, `Posterior Instrumented Fusion: Upper / Lower Levels`] %>% 
  sapply(. %>% strsplit('-') %>% .[[1]] %>% .[2]) ->
  post_intr_fusion

data_ %<>% .[post_intr_fusion == 'Iliac']
```
Posterior Instrumental Fusion is Iliac: `r data_[, .N]`

```{r}
non_stable <- readLines('non_stable_degree.txt')
greater_than_10 <- data_[abs(diff_lordosis) >= 10, `Code of the patient`]
greater_than_10 <- greater_than_10 %¡in% non_stable
data_ %<>% .[!(`Code of the patient` %in% greater_than_10)]
```
Differences smaller than 10º in 6W-2Y Lordosis (top of L1-S1): `r data_[, .N]`

```{r}
data_ %<>% .[complications_ever=='No']
```
Without complications (PJK, PJF, DJK, DJF) ever after surgery: `r data_[, .N]`


*Increment = Future - Baseline*

### Estability Increment Quality of Life

```{r include=TRUE}
calc_estability(data_, factors_loss$qualitylife)
```

### Estability Increment Radiology


```{r include=TRUE}
demo <- factors_loss[c('demographic_0', 'demographic_1', 'surgical')]
calc_estability(data_, factors_loss$radiologic, demo)
```

