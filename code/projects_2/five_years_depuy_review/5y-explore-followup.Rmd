---
title: "5y followup analysis"
output:
  pdf_document: default
  html_document: default
always_allow_html: yes
---

  
```{r setup, include=FALSE}
knitr::opts_knit$set(
  echo = FALSE, 
  root.dir=normalizePath('../'),
  warning=FALSE, 
  comment="",
  message=FALSE
)
```

<!-- xls_path <- '../../data/ESSG Extraction_DEC_OP_ NON DePuy v7.xlsx' -->


```{r echo=TRUE}
xls_path <- '../../data/Dataset 4th report 5Y - ONLY DPS.xlsx'
```

```{r warning=FALSE, echo=FALSE, include=FALSE}
library(stringr)
library(ggplot2)
library(zeallot)
library(gridExtra)
library(Hmisc)

source('five_years/five_years-utils.R')

ncols_plots <- 2

outcomes <- c(
  '5Y. ODI - Score (%)', '5Y. SRS22 - SRS Subtotal score', '5Y. SF36 - PCS', '5Y. SF36 - MCS', 
  '5Y. SRS22 - Satisfaction with management'
)

c(data_set_0, predictive_vars, .) %<-% get_data(xls_path, clean=FALSE)
data_set <- data_set_0 %>% copy

complications <- read_excel(xls_path, sheet='Complications') %>%
  as.data.table %>%
  .[`Complication Impact` == 'Major Complication'] 

demographics <- read_yaml('five_years/demographic.yml')
demographics_all <- demographics %>% unlist


outcomes %>% 
  lapply(. %>% str_replace_all('5', '2')) ->
  outcomes_2y
names(outcomes_2y) <- outcomes

outcomes %>% 
  lapply(. %>% str_replace_all('5', '3')) ->
  outcomes_3y
names(outcomes_3y) <- outcomes

outcomes %>% 
  lapply(. %>% str_replace_all('5', '6')) ->
  outcomes_6y
names(outcomes_6y) <- outcomes

outcomes %>% 
  sapply(. %>% get_base_outcome(first_visit=TRUE)) ->
  base_outcomes 

for( outcome in names(outcomes_6y)){
  outcome_6y <- outcomes_6y[[outcome]]
  outcome_2y <- outcomes_2y[[outcome]]
  outcome_3y <- outcomes_3y[[outcome]]
  data_set %<>%
    .[is.na(get(outcome)), c(outcome) := get(outcome_6y)] %>% 
    .[is.na(get(outcome_2y)), c(outcome_2y) := get(outcome_3y)]
}

# outcome_2y <- outcomes_2y[[1]]
# outcome <- outcomes[[1]]

if( 'Major curve Cobb angle' %in% colnames(data_set)){
  setnames(data_set, 
    "Major curve Cobb angle", "Static Major curve Cobb angle")
}

study_vars <- c(
  outcomes, outcomes_2y %>% unlist, 
  demographics_all, base_outcomes, 
  'Code of the patient', 
  'Site', 
  'Study', 
  'Vital status', 
  'st1. Date of Stage', 
  '2 YEAR VISIT - Date of visit',
  '3 YEAR VISIT - Date of visit',
  '5 YEAR VISIT - Date of visit',
  '6 YEAR VISIT - Date of visit'
) %>% unique
data_set %<>% 
  .[, .SD, .SDcols=study_vars] 
```



### FU Stats
```{r}
data_set %<>% 
  .[, followup_2y := 
      !is.na(`2 YEAR VISIT - Date of visit`) | 
      !is.na(`3 YEAR VISIT - Date of visit`)] %>% 
  .[, followup_5y := 
      !is.na(`5 YEAR VISIT - Date of visit`) | 
      !is.na(`6 YEAR VISIT - Date of visit`)] 

followup_2y <- data_set %>% 
  .[followup_2y==TRUE] %>% 
  .[, `Code of the patient` %>% uniqueN]

followup_5y <- data_set %>% 
  .[followup_5y==TRUE] %>% 
  .[, `Code of the patient` %>% uniqueN]

total <- data_set[, .N]
total_with_followup_2y <- data_set[followup_2y==TRUE, .N]
perc_followup_2y <- round(followup_2y/total, 3)
perc_followup_5y <- round(followup_5y/total, 3)
perc_followup_5y_with_2y <- round(followup_5y/total_with_followup_2y, 3)
```

- Patients with at least 5 year from intervention (total variable): `r total`
- Patients with 2y number (followup_2y variable): `r followup_2y`
- Patients with 2y % (perc_followup_2y variable): `r perc_followup_2y*100`
- Patients with 5y number (followup_5y variable): `r followup_5y`
- Patients with 5y % (perc_followup_5y variable): `r perc_followup_5y*100`
- Patients (among 2y FU) with 5y % (perc_followup_5y_with_2y variable): `r perc_followup_5y_with_2y*100`


### Filters
```{r warning=FALSE }
# discarded_patients <- readLines('five_years/discarded_patients')

data_set %<>%
  .[followup_2y==TRUE] %>%
  .[`st1. Date of Stage` %>% as.Date() < as.Date('2016-6-1')]
```

Total patients: `r data_set[, .N]`

# MCIDS

```{r echo=FALSE, comment=""}
mcids <- list()
mcids[['5Y. ODI - Score (%)']] <- 12.8
mcids[['5Y. SRS22 - SRS Subtotal score']] <- 0.43
mcids[['5Y. SF36 - PCS']] <- 4.9
mcids
```


```{r echo=FALSE, comment=""}
base_mcids <- mcids %>% names %>% 
  sapply(. %>% get_base_outcome(first_visit = TRUE), USE.NAMES = TRUE) %>% 
  as.list

data_set_ <- data_set %>% copy()

res <- data.frame()
for( qual_var_5y in mcids %>% names ){
  qual_var_root <- gsub("5Y. ", "", qual_var_5y)
  base_qual_var <- base_mcids[[qual_var_5y]] 
  qual_var_2y <- outcomes_2y[[qual_var_5y]]
  inc_qual_var_5y <- "{qual_var_5y}_inc" %>% f
  inc_qual_var_2y <- "{qual_var_2y}_inc" %>% f
  inc_qual_var_5y_2y <- "{qual_var_root}_5y_2y_inc" %>% f


  data_set_[, c(inc_qual_var_2y) := get(qual_var_2y) - get(base_qual_var)]
  data_set_[, c(inc_qual_var_5y) := get(qual_var_5y) - get(base_qual_var)]
  data_set_[, c(inc_qual_var_5y_2y) := get(qual_var_5y) - get(qual_var_2y)]

  inc_qual_var_2y_n <- data_set_[, get(inc_qual_var_2y) %>% na.omit %>% length]
  inc_qual_var_5y_n <- data_set_[, get(inc_qual_var_5y) %>% na.omit %>% length]
  inc_qual_var_5y_2y_n <- data_set_[, get(inc_qual_var_5y_2y) %>% na.omit %>% length]
  
  if( grepl('ODI', qual_var_5y, fixed=TRUE) ){
    inc_2y_prop <- data_set_ %>%
      .[, get(inc_qual_var_2y) < -mcids[[qual_var_5y]]] %>% na.omit() 
    inc_5y_prop <- data_set_ %>%
      .[, get(inc_qual_var_5y) < -mcids[[qual_var_5y]]] %>% na.omit() 
    inc_5y_2y_prop <- data_set_ %>%
      .[, get(inc_qual_var_5y_2y) < -mcids[[qual_var_5y]]] %>% na.omit() 
  }else{
    inc_2y_prop <- data_set_ %>%
      .[, get(inc_qual_var_2y) > mcids[[qual_var_5y]]] %>% na.omit() 
    inc_5y_prop <- data_set_ %>%
      .[, get(inc_qual_var_5y) > mcids[[qual_var_5y]]] %>% na.omit() 
    inc_5y_2y_prop <- data_set_ %>%
      .[, get(inc_qual_var_5y_2y) > mcids[[qual_var_5y]]] %>% na.omit()
  }

  
  p_val <- prop.test(
    c(sum(inc_2y_prop), sum(inc_5y_prop)),
    c(len(inc_2y_prop), len(inc_5y_prop))
  )
  
  inc_2y_percent <- inc_2y_prop %>% mean %>% round(3)
  inc_5y_percent <- inc_5y_prop %>% mean %>% round(3)
  inc_5y_2y_percent <- inc_5y_2y_prop %>% mean %>% round(3)

  
  res %<>% rbind(data.frame(
    variable = qual_var_root,
    inc_2y_percent = inc_2y_percent * 100,
    inc_2y_n = inc_qual_var_2y_n,
    inc_5y_percent = inc_5y_percent * 100,
    inc_5y_n = inc_qual_var_5y_n,
    p_val_two_previous = p_val$p.value %>% round(3),
    inc_5y_2y_percent = inc_5y_2y_percent * 100,
    inc_5y_2y_n = inc_qual_var_5y_2y_n
  ))  
}

res
```

# PASS

```{r echo=FALSE, comment=""}
pass <- list()
pass[['5Y. ODI - Score (%)']] <- 18
pass[['5Y. SRS22 - SRS Subtotal score']] <- 3.5
pass
```


```{r echo=FALSE, comment=""}
base_pass <- pass %>% names %>% 
  sapply(. %>% get_base_outcome(first_visit = TRUE), USE.NAMES = TRUE) %>% 
  as.list

data_set_ <- data_set %>% copy()

res <- data.frame()
for( qual_var_5y in pass %>% names ){
  qual_var_root <- gsub("5Y. ", "", qual_var_5y)
  base_qual_var <- base_pass[[qual_var_5y]] 
  qual_var_2y <- outcomes_2y[[qual_var_5y]]
  
  prop_2y <- data_set_ %>%
    .[, get(qual_var_2y) < pass[[qual_var_5y]]] %>% na.omit()
  n_2y <- data_set_[, get(qual_var_2y) %>% na.omit %>% length]
  prop_5y <- data_set_ %>%
    .[, get(qual_var_5y) < pass[[qual_var_5y]]] %>% na.omit()
  n_5y <- data_set_[, get(qual_var_2y) %>% na.omit %>% length]
  
  p_val <- prop.test(
    c(sum(prop_2y), sum(prop_5y)),
    c(len(prop_2y), len(prop_5y))
  )
  
  prop_2y <- prop_2y %>% mean %>% round(3)
  prop_5y <- prop_5y %>% mean %>% round(3)

  
  res %<>% rbind(data.frame(
    variable = qual_var_root,
    prop_2y = prop_2y * 100,
    n_2y = n_2y,
    prop_5y = prop_5y * 100,
    n_5y = n_5y,
    p_val = p_val$p.value %>% round(3)
  ))  
}

res
```

