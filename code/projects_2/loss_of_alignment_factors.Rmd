---
title: "Loss of alignment"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include=FALSE, message=FALSE, warning=FALSE, comment="")
```

```{r}
library(data.table)
library(magrittr)
library(yaml)
library(DiagrammeR)
library(lme4)
library(lmerTest)

source('patient_selection.R')
factors_loss <- read_yaml('factors_loss.yml')
```

```{r, message=FALSE}
analysis_vars <- read_yaml('descriptive.yml')
data_ <- get_data()
```
Initial Patients: `r data_[, .N]`

```{r}
data_ %<>% .[`Posterior Instrumented Fusion` == 'Yes']
```
With Posterior Instrumented Fusion: `r data_[, .N]`

```{r}
data_[, `Posterior Instrumented Fusion: Upper / Lower Levels`] %>% 
  sapply(. %>% strsplit('-') %>% .[[1]] %>% .[2]) ->
  post_intr_fusion

data_ %<>% .[post_intr_fusion == 'Iliac']
```
Posterior Instrumental Fusion is Iliac: `r data_[, .N]`

```{r}
non_stable <- readLines('non_stable_degree.txt')
greater_than_10 <- data_[abs(diff_lordosis) >= 10, `Code of the patient`]
greater_than_10 <- greater_than_10 %¡in% non_stable
data_ %<>% .[!(`Code of the patient` %in% greater_than_10)]
```
Differences smaller than 10º in 6W-2Y Lordosis (top of L1-S1): `r data_[, .N]`

```{r}
data_ %<>% .[complications_ever=='No']
```
Without complications (PJK, PJF, DJK, DJF) ever after surgery: `r data_[, .N]`


```{r echo=FALSE}
grViz('
digraph rmarkdown {

  graph [
    rankdir = UD
  ]
  
  node [
    shape=circle,
    fixedsize=true,
    width=1.2,
    style=filled,
    fillcolor=aquamarine2,
    fontsize=15
    ]

 
  D[label="Demographic"]
  P[label="Individual\nTraits", style="dashed"]
  R[label="Radiologic\n(Deformity)"]
  H[label="Quality of\nLife"]
  C[label="PKJ/PJF\nDJK/DJF"]
  
  D -> R 
  P -> R
  P -> H
  D -> H
  H -> C
  D -> C
  R -> C
  P -> C
  
  
  {rank=same; P;D}
  {rank=same; R;H}
  {rank=same; C}
}                  
')
```

```{r}
print(factors_loss)
```

Numer of patients with complications (pjf/pjk/djk/djf) before 6m
```{r include=TRUE}
data_[, .N, complications_ever]
```

"- j -" stands for: pjk/pjf/djk/djf

# Demographic Factors -j-

```{r include=TRUE}
cols_ <- factors_loss$demographic_0
data_ %>% 
  .[, .SD, .SDcols = c('complications_ever', cols_)] %>% 
  .[, complications_ever:=ifelse(complications_ever=='Yes', 1, 0)] %>% 
  glm(complications_ever~., ., family='binomial') ->
  factor_model_demo

summary(factor_model_demo)
```


# Demographic Factors 2 -j- before 6m 

```{r include=TRUE}
cols_ <- c(
  factors_loss$demographic_0,
  factors_loss$demographic_1
)
data_ %>% 
  .[, .SD, .SDcols = c('complications_ever', cols_)] %>% 
  .[, complications_ever:=ifelse(complications_ever=='Yes', 1, 0)] %>% 
  glm(complications_ever~., ., family='binomial') ->
  factor_model_demo

summary(factor_model_demo)
```

# Baseline Factors -j- ever

```{r include=TRUE}
cols_ <- c(
  factors_loss$demographic_0,
  factors_loss$demographic_1,
  factors_loss$radiologic,
  factors_loss$qualitylife
)
data_ %>%
  .[, .SD, .SDcols = c('complications_ever', cols_)] %>%
  .[, complications_ever:=ifelse(complications_ever=='Yes', 1, 0)] %>%
  glm(complications_ever~., ., family='binomial') ->
  factor_model_baseline

summary(factor_model_baseline)
```


