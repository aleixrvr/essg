---
title: "Long/Short Propensity Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, comment='', message=FALSE, warning=FALSE)
```

```{r}
library(readxl)
library(yaml)
library(kableExtra)
library(pROC)
source('utils.R')
source('train.R')
treatment_name <- 'longshort'
xls_path <- '../data/ESSG extraction July 2021 DEF.xlsx'
default_degree <- 0
tuneLength <- 15
```

```{r, include=FALSE, cache=FALSE}
knitr::read_chunk('data_preparation.R')
```

```{r, read_data}
```

For the `r "\"{colnames(diagnosis) %>% intersect(vars$confounders)}\"" %>% f` variables, we take the first diagnosis (among the many there are).

### Long - Short defintion
```{r, long_short}
```


### Data Transformation

- Missing "Cobb LS curve (Degree)" and "Cobb TL/L curve (Degree)" imputed with `r default_degree` degrees
- "Degenerative disease: Spinal Stenosis" = Yes, means if it has Central, Left Foraminal and Right Foraminal at the same time

```{r, variable_transformations}
```

### Patient Selection
```{r echo=TRUE, patient_selection}
```


## Patient Stats

### Selected Patients

```{r}
data_ %>% 
  .[, .N, longshort]
```


### Selecting comparable patients

```{r echo=TRUE, comparable_patients}
```


### Confounding Variables

```{r}
confounders <- vars$confounders
outcomes <- vars$outcomes
vars_ <- c(confounders, 'longshort')
confounders %>% as.yaml %>% cat
```


# Propensity Score

## Logistic Regression 

```{r}
data_model <- data_ %>% 
  .[, .SD, .SDcols = vars_] %>% 
  na.omit 
best_model <- data_model %>% 
  as.data.table %>% 
  train_model('longshort', models='lm')
data_model %<>% cross_fitting(best_model, treatment_name)
```

```{r}
propensities <- data_model %>% 
  .[, .(propensity=propensity, treatment = longshort)]
auc_result <- auc(roc(propensities$treatment, propensities$propensity))
ggplot(propensities, aes(propensity, fill=treatment, color=treatment)) +
  geom_density(alpha = 0.1) +
  xlim(c(0, 1)) +
  ggtitle('Propensity of being short\nAUC: {auc_result}' %>% f)
```



## Elastic Net

```{r}
data_model <- data_ %>% 
  .[, .SD, .SDcols = vars_] %>% 
  na.omit
best_model <- data_model %>% 
  as.data.table %>% 
  train_model(treatment_name, models='elastic', tuneLength = tuneLength)
data_model %<>% cross_fitting(best_model, treatment_name)
```

```{r}
propensities <- data_model %>% 
  .[, .(propensity=propensity, treatment = longshort)]
auc_result <- auc(roc(propensities$treatment, propensities$propensity))
ggplot(propensities, aes(propensity, fill=treatment, color=treatment)) +
  geom_density(alpha = 0.1) +
  xlim(c(0, 1)) +
  ggtitle('Propensity of being short\nAUC: {auc_result}' %>% f)
```

## Boosting

```{r}
data_model <- data_ %>% 
  .[, .SD, .SDcols = vars_] %>% 
  na.omit
best_model <- data_model %>% 
  as.data.table %>% 
  train_model(treatment_name, models='boosting', tuneLength = tuneLength)
data_model %<>% cross_fitting(best_model, treatment_name)
```

```{r}
propensities <- data_model %>% 
  .[, .(propensity=propensity, treatment = longshort)]
auc_result <- auc(roc(propensities$treatment, propensities$propensity))
ggplot(propensities, aes(propensity, fill=treatment, color=treatment)) +
  geom_density(alpha = 0.1) +
  xlim(c(0, 1)) +
  ggtitle('Propensity of being short\nAUC: {auc_result}' %>% f)
```